{% extends 'layout.html.twig' %}

{% set custom_css = '' %}

{% if radio_table.appearance.theme is empty %}
    {% if radio_table.appearance.textColor %}
        {% set custom_css = custom_css ~ '.customizable-color { color: ' ~ radio_table.appearance.textColor ~ ' }' %}
    {% endif %}

    {% if radio_table.appearance.backgroundColor %}
        {% set custom_css = custom_css ~ '.customizable-background { background: ' ~ radio_table.appearance.backgroundColor %}
        {% if radio_table.appearance.backgroundImage %}
            {% set custom_css = custom_css ~ ' url("' ~ radio_table.appearance.backgroundImage ~ '") center fixed' %}
        {% endif %}
        {% set custom_css = custom_css ~ ' }' %}
    {% endif %}
{% endif %}

{% block html_classes %}
    {%- if custom_css or radio_table.appearance.theme %}customized-radio-table{% endif -%}
    {%- if radio_table.appearance.theme %} theme-{{ radio_table.appearance.theme }}{% endif -%}
    {%- if radio_table.appearance.fullWidth %} full-width{% endif -%}
{% endblock %}

{% block page_title %}{{ radio_table.name }}{% endblock %}

{% block head_closing %}
    {% if radio_table.status != constant('STATUS_PUBLIC', radio_table) %}
        <meta name="robots" content="noindex, noarchive">
    {% endif %}

    {% if custom_css %}<style>{{ custom_css|raw }}</style>{% endif %}
    {% if radio_table.appearance.theme %}
        <link rel="stylesheet" href="{{ asset('themes.css') }}">
    {% endif %}

    <script src="{{ asset('radio-table.js') }}"></script>
{% endblock %}

{% block context_menu %}
    {% if is_granted('RADIO_TABLE_MODIFY', radio_table) %}
        <ul>
            <li>
                <a href="{{ path('radio_station.add', {radioTableId: radio_table.id}) }}">
                    {{ 'radio_station.add.title'|trans }}
                </a>
            </li>
            <li>
                <a href="{{ path('radio_table.settings', {id: radio_table.id}) }}">
                    {{ 'radio_table.settings.title'|trans }}
                </a>
            </li>
        </ul>
    {% endif %}
{% endblock %}

{% block page_content %}
    <header class="customizable-color">
        <h1>{{ radio_table.name }}</h1>
    </header>

    {% if radio_table.radioStationsCount > 0 %}
        <div class="radio-table-container customizable-color">
            {% embed 'radio_table/table/radio_table.html.twig' %}
                {%- block table_class 'radio-table sortable' -%}

                {%- block heading_cell -%}
                    {%- set columns_sorting = {
                        (constant('App\\Entity\\RadioTable::COLUMN_DISTANCE')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_FREQUENCY')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_MAX_SIGNAL_LEVEL')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_POWER')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_PRIVATE_NUMBER')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_QUALITY')): 'N',
                        (constant('App\\Entity\\RadioTable::COLUMN_COUNTRY')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_FIRST_LOG_DATE')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_LOCALITY')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_LOCATION')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_NAME')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_POLARIZATION')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_RADIO_GROUP')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_RECEPTION')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_RDS_PI')): 'T',
                        (constant('App\\Entity\\RadioTable::COLUMN_TYPE')): 'T',
                    } -%}
                    <th {% if columns_sorting[column] is defined %}data-sort="{{ columns_sorting[column] }}"{% endif %}>
                        {{- parent()|striptags -}}
                    </th>
                {%- endblock -%}

                {# Check for permission outside of radio_station loop for better performance. #}
                {% set is_granted = is_granted('RADIO_TABLE_MODIFY', radio_table) %}

                {%- block radio_station_name -%}
                    {%- if is_granted -%}
                        <a href="{{ path('radio_station.edit', {id: radio_station.id, radioTableId: radio_station.radioTable.id}) }}">
                            {{- radio_station.name -}}
                        </a>
                    {%- else -%}
                        {{- radio_station.name -}}
                    {%- endif -%}
                {%- endblock -%}

                {%- block radio_station_rds -%}
                    {%- set rds_rt = [] -%}
                    {%- for frame in radio_station.rds.rt -%}
                        {%- set rds_rt = rds_rt|merge([frame|replace({'_':' '})|escape]) -%}
                    {%- endfor -%}

                    {%- set rds_ps_groups = [] -%}
                    {%- for group_key in radio_station.rds.ps|keys -%}
                        {%- set group = [] -%}
                        {%- for frame in radio_station.rds.ps[group_key] -%}
                            {%- set group = group|merge([frame|replace({'_':' '})|align_rds_frame|escape]) -%}
                        {%- endfor -%}
                        {%- set rds_ps_groups = rds_ps_groups|merge([group]) -%}
                    {%- endfor -%}

                    {%- set rds_pty = radio_station.rds.pty|escape -%}

                    <span data-pty="{{ rds_pty|json_encode|escape('html_attr') }}"
                          data-rt="{{ rds_rt|json_encode|escape('html_attr') }}"
                          data-ps="{{ rds_ps_groups|json_encode|escape('html_attr') }}"
                          class="rds rds-popup-enabled">
                        {{- radio_station.rds.ps|first|first|replace({'_':' '})|align_rds_frame -}}
                    </span>
                {%- endblock -%}
            {% endembed %}

            <template class="rds-popup-template">
                <section class="rds-popup" role="alert">
                    <h2>{{ 'radio_table.show.rds_popup.title'|trans }}</h2>
                    <dl>
                        <div class="rds-popup-ps-row">
                            <dt>{{ 'radio_table.show.rds_popup.ps'|trans }}</dt>
                            <dd class="rds-popup-ps-value"></dd>
                        </div>
                        <div class="rds-popup-rt-row">
                            <dt>{{ 'radio_table.show.rds_popup.rt'|trans }}</dt>
                            <dd class="rds-popup-rt-value rds-wrap"></dd>
                        </div>
                        <div class="rds-popup-pty-row">
                            <dt>{{ 'radio_table.show.rds_popup.pty'|trans }}</dt>
                            <dd class="rds-popup-pty-value"></dd>
                        </div>
                    </dl>
                </section>
            </template>
        </div>

        <section class="radio-table-details customizable-color">
            <h3 class="sr-only">{{ 'radio_table.show.heading.details'|trans }}</h3>

            {{ radio_table.description|raw }}
            <dl>
                <div>
                    <dt>{{ 'radio_table.detail.radio_stations_count'|trans }}</dt>
                    <dd>{{ radio_table.radioStationsCount }}</dd>
                </div>
                <div>
                    <dt>{{ 'radio_table.detail.last_update_time'|trans }}</dt>
                    <dd>{{ radio_table.lastUpdateTime|date_format }}</dd>
                </div>
                {% if radio_table.owner.publicProfile %}
                    <div>
                        <dt>{{ 'radio_table.detail.author'|trans }}</dt>
                        <dd>
                            <a href="{{ path('user.public_profile', {name: radio_table.owner.name}) }}">
                                {{ radio_table.owner.name }}
                            </a>
                        </dd>
                    </div>
                {% endif %}
            </dl>
        </section>
    {% else %}
        <p class="information">
            {% if is_granted('RADIO_TABLE_MODIFY', radio_table) %}
                {{ 'radio_table.show.information.empty_editable'|trans({
                    '%anchor%': '<a href="' ~ path('radio_station.add', {radioTableId: radio_table.id}) ~ '">',
                    '%anchor_end%': '</a>',
                })|raw }}
            {% else %}
                {{ 'radio_table.show.information.empty'|trans }}
            {% endif %}
        </p>
    {% endif %}
{% endblock %}
